<script>
    // Initialize Firebase as before
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);
    const auth = firebase.auth();

    let userGroup = ""; // To store the logged-in user's group

    // Fetch user details and group on authentication state change
    auth.onAuthStateChanged((user) => {
        if (user) {
            const userId = user.uid;
            const userRef = database.ref(`users/${userId}`);

            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const userName = user.displayName;
                    userGroup = userData.group; // Fetch user's group

                    document.getElementById('userName').innerText = `Username: ${userName}`;
                    document.getElementById('userGroup').innerText = `Group: ${userGroup}`;

                    // Load messages for the user's group
                    loadGroupMessages(userGroup);
                } else {
                    console.error("User data not found.");
                }
            }).catch((error) => {
                console.error("Error fetching user data:", error);
            });
        } else {
            console.log("User is not logged in.");
            window.location.href = 'index.html';
        }
    });

    // Function to load messages for the user's group
    function loadGroupMessages(group) {
        const groupMessagesRef = database.ref(`messages/${group}`);
        groupMessagesRef.on("child_added", (snapshot) => {
            const messageData = snapshot.val();
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            messageElement.innerHTML = `<strong>${messageData.username}:</strong> ${messageData.message} <small>${formatDate(messageData.timestamp)}</small>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to the latest message
        });
    }

    // Function to send a message to the user's group
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && userGroup) {
            const timestamp = new Date().toISOString();
            const username = auth.currentUser ? auth.currentUser.displayName : "Anonymous";

            // Push message to the user's group in Firebase
            const groupMessagesRef = database.ref(`messages/${userGroup}`);
            groupMessagesRef.push({
                username: username,
                message: message,
                timestamp: timestamp
            });
            messageInput.value = "";
        }
    }

    // Attach event listener to the send button
    document.getElementById("sendButton").addEventListener("click", sendMessage);

    // Function to format date and time
    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString();
    }
</script>
